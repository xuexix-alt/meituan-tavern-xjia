# 美团核心逻辑脚本 - 配置指南

本脚本用于实现“美人团APP”的智能分流逻辑，区分系统后台模式与角色扮演模式。

## 1. 如何使用

1. **新建世界书条目**：在酒馆的世界书中，创建一个新条目。
2. **命名**：建议命名为 `[脚本]美团核心逻辑`（名字不影响功能，方便管理即可）。
3. **触发设置**：将触发方式设置为 **`常驻 (Constant)`**。
    * *注意*：由于脚本使用了 `@@preprocessing`，它会在每次发送消息前自动运行，所以必须设为常驻以确保每次都能拦截判断。
4. **粘贴代码**：打开 `初始模板/美团核心逻辑脚本.txt`，将其全部内容复制并粘贴到该条目的“内容”框中。

## 2. 如何修改参数

脚本顶部的 `// =================配置区域=================` 是您可以自由修改的部分。

### 2.1 修改触发关键词

如果您想改变触发“系统模式”或“下单”的词汇，请修改 `KEYWORDS` 对象：

```javascript
const KEYWORDS = {
    // 这里是系统模式的触发词，只要用户包含其中任意一个，就会进入后台模式
    SYSTEM: ['搜索', '首页', '生成', '我的自定义触发词'],

    // 这里是下单模式的触发词
    ORDER: ['下单', '我要玩', '点单']
};
```

### 2.2 修改世界书条目映射

脚本通过 `getwi(null, '条目名称')` 来调用其他的规则。**您必须确保脚本里写的名字，与您实际世界书里条目的名字完全一致（包括符号）。**

如果您的世界书条目改名了，请修改 `WI_NAMES` 对象：

```javascript
const WI_NAMES = {
    // 格式： 代码中的代号 : '您实际的世界书条目名称'

    APP_CONFIG:      '规则_APP总设定',          // 对应 APP系统后台规则
    WORLD_VIEW:      '规则_通用扮演与世界观',    // 对应 基本世界观和通用扮演规则
    RP_RULES:        '规则_角色扮演库',         // 对应 角色扮演规则库
    VAR_UPDATE:      '规则_变量更新',           // 对应 变量更新规则

    // ...
};
```

**示例**：
如果您把 `APP系统后台规则.txt` 的内容放到了一个叫 `[System]MainConfig` 的条目里，您就需要把上面那行改成：
`APP_CONFIG: '[System]MainConfig',`

## 3. 常见问题

* **Q: 脚本报错 `getwi is not defined`**
  * A: 确保您的酒馆环境支持该简写函数。如果不支持，请尝试将其替换为 `SillyTavern.loadWorldInfo` 或检查您的全局脚本设置。
* **Q: 变量读取失败**
  * A: 脚本使用了 `getvar` 读取变量。请确保您已经安装了 MVU 框架或相关的变量管理插件，并且 `stat_data` 的路径是正确的。
* **Q: 系统模式下还是会出现扮演内容**
  * A: 检查 `WI_NAMES.APP_CONFIG` 对应的条目内容，确保里面没有包含扮演规则。脚本已经通过 `if (isSystemMode)` 屏蔽了 `RP_RULES` 的加载，只要 `APP总设定` 里是纯净的，就不会有扮演内容。

## 4. 进阶：细分加载

在代码的 `// 3. 智能加载细分规则` 部分，我注释掉了一段代码。如果您希望节省 Token，可以取消注释并完善它：

```javascript
    if (isServing) {
        // 您需要确保变量里存了 type 字段
        const currentType = activeOrders.find(o => o.status === '服务中')?.type;

        if (currentType === '熟人') {
             // 这里填入您熟人规则的条目名
             // <%- await getwi(null, '规则_熟人商品') %>
        }
    }
```

这样 AI 就只会加载当前需要的规则，而不是把所有规则一股脑塞进去。
