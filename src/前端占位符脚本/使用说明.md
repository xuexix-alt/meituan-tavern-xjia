# 前端占位符检查与插入脚本

## 功能说明

这是一个酒馆助手脚本，用于自动检查当前楼层消息中是否包含【前端占位符】，如果没有则自动插入。

## 主要功能

### 1. 自动检查与插入
- 检查当前楼层的所有消息内容
- 如果发现缺少【前端占位符】，自动在消息末尾插入
- 支持自定义占位符文本

### 2. 手动检查
- 提供"检查占位符"按钮，可手动触发检查
- 检查完成后显示相应提示信息

### 3. 事件监听
- 监听消息发送事件，新消息产生后自动检查
- 监听聊天文件切换事件

## 脚本设置

脚本支持以下可配置选项（通过脚本变量设置）：

```typescript
{
  enabled: boolean          // 是否启用脚本（默认：true）
  placeholder_text: string  // 占位符文本（默认：【前端占位符】）
  auto_insert: boolean      // 是否自动插入（默认：true）
  show_notification: boolean// 是否显示通知（默认：true）
}
```

## 使用方法

### 1. 在酒馆助手中导入脚本
将 `dist/前端占位符脚本/index.js` 上传到酒馆助手的脚本库中。

### 2. 配置脚本设置
在脚本设置中可调整：
- 启用/禁用脚本
- 修改占位符文本
- 开启/关闭自动插入
- 开启/关闭通知提示

### 3. 使用脚本

#### 自动模式
- 启用 `auto_insert` 后，脚本会在每次发送消息后自动检查
- 如果当前楼层缺少占位符，自动插入

#### 手动模式
- 点击"检查占位符"按钮手动触发检查
- 脚本会检查当前楼层并在必要时插入占位符

## 技术实现

### 使用的酒馆助手接口

1. **变量操作**
   - `getVariables()` - 读取脚本设置
   - `replaceVariables()` - 保存脚本设置
   - `getScriptId()` - 获取脚本ID

2. **消息处理**
   - `getChatMessages()` - 获取当前楼层消息
   - `getCurrentMessageId()` - 获取当前消息ID
   - `triggerSlash()` - 执行STScript命令更新消息

3. **事件系统**
   - `eventOn()` - 注册事件监听
   - `getButtonEvent()` - 获取按钮事件

4. **UI提示**
   - `toastr.success/info/error()` - 显示通知

### 核心函数

1. **`checkAndInsertPlaceholder()`**
   - 检查当前楼层消息
   - 判断是否需要插入占位符
   - 执行插入操作

2. **`insertPlaceholder(content)`**
   - 在消息内容末尾插入占位符
   - 自动处理换行符

3. **`containsPlaceholder(message)`**
   - 检查消息是否已包含占位符

## 注意事项

1. **权限要求**
   - 脚本需要修改消息的权限
   - 确保在酒馆助手中授予相应权限

2. **消息格式**
   - 脚本会保留原有的消息格式和角色标识
   - 占位符会插入到每条消息的末尾

3. **错误处理**
   - 脚本包含完善的错误捕获机制
   - 执行失败时会显示错误提示

4. **性能优化**
   - 消息发送后延迟100ms再检查，确保消息已保存
   - 使用事件监听避免重复检查

## 脚本日志

脚本运行时会输出详细的日志信息，可在浏览器控制台中查看：

- `[前端占位符] 脚本已加载` - 脚本加载完成
- `[前端占位符] 当前楼层无消息内容` - 当前楼层无消息
- `[前端占位符] 当前楼层已包含占位符，跳过插入` - 已有占位符
- `[前端占位符] 已插入占位符到当前楼层` - 成功插入
- `[前端占位符] 执行失败: xxx` - 执行出错

## 扩展功能

### 自定义占位符文本
```typescript
// 修改脚本设置
updateSettings({
  placeholder_text: '【自定义占位符】'
});
```

### 禁用自动插入，只使用手动模式
```typescript
updateSettings({
  auto_insert: false,
  show_notification: true
});
```

## 文件结构

```
src/前端占位符脚本/
├── index.ts          # 脚本主文件
└── 使用说明.md       # 本文档
```

构建后会生成：
```
dist/前端占位符脚本/
├── index.js          # 编译后的脚本文件
└── index.js.map      # 源码映射文件
```

## 更新日志

### v1.0.0 (2025-11-19)
- 初始版本发布
- 支持自动检查和插入【前端占位符】
- 支持手动检查功能
- 支持自定义占位符文本
- 支持事件监听和通知提示
