# 前端占位符检查脚本

## 功能说明

这是一个酒馆助手脚本，用于自动检查AI生成完毕后的聊天内容中是否包含【前端占位符】，如果没有就自动在消息末尾添加。

## 主要功能

### 1. 自动检测和添加
- 监听AI生成完成事件 (`tavern_events.GENERATION_ENDED`)
- 自动检查最新生成的消息楼层
- 如果没有【前端占位符】，自动在消息末尾另起一行添加
- 显示"已经成功为您增加了标签！"提示

### 2. 手动检查功能
- 提供脚本按钮"检查占位符"
- 可手动触发对最新消息的检查和添加

### 3. 完善的错误处理
- 捕获所有可能的异常
- 使用toastr显示友好的用户提示
- 在浏览器控制台输出详细日志

## 使用方法

### 1. 在酒馆助手中使用
1. 将 `dist/前端占位符检查脚本/index.js` 上传到酒馆助手的脚本库
2. 启用脚本
3. 脚本会自动在后台运行

### 2. 使用方式
- **自动模式**：AI生成回复后自动检查并添加占位符
- **手动模式**：点击脚本按钮"检查占位符"手动检查最新消息

## 技术特点

### 使用的酒馆助手API
- `eventOn(tavern_events.GENERATION_ENDED)` - 监听AI生成完成
- `getChatMessages(message_id)` - 获取指定楼层消息
- `setChatMessages()` - 修改消息内容
- `getLastMessageId()` - 获取最新消息楼层ID
- `replaceScriptButtons()` - 添加脚本按钮
- `getButtonEvent()` - 获取按钮事件

### 代码结构
```
src/前端占位符检查脚本/
├── index.ts                    # 主入口文件
├── 加载和卸载时执行函数.ts      # 脚本加载/卸载处理
├── 监听AI生成完成.ts          # 核心功能实现
├── 添加按钮和注册按钮事件.ts  # 手动检查按钮
└── 使用说明.md               # 本文档
```

## 日志和提示

### 用户提示
- **脚本启动**："前端占位符检查脚本已加载!"
- **脚本关闭**："前端占位符检查脚本已卸载!"
- **自动添加成功**："自动添加界面成功！"（标题："自动检测完成"）
- **手动添加成功**："手动添加界面成功！"（标题："手动操作完成"）
- **检查中**："正在检查最新消息的占位符..."
- **无消息**："当前聊天没有消息"

### 控制台日志
- `[前端占位符] 自动已在第 X 楼添加占位符`
- `[前端占位符] 手动已在第 X 楼添加占位符`
- `[前端占位符] 第 X 楼已包含占位符，跳过自动添加`
- `[前端占位符] 第 X 楼已包含占位符，跳过手动添加`
- `[前端占位符] 自动检查第 X 楼消息`
- `[前端占位符] 手动检查最新消息`
- `[前端占位符] 无法获取消息内容`
- `[前端占位符] 自动处理第 X 楼消息时出错: 错误详情`
- `[前端占位符] 手动处理第 X 楼消息时出错: 错误详情`

## 注意事项

1. **延迟处理**：脚本会在AI生成完成后延迟100ms再检查，确保消息已完全保存
2. **仅处理AI消息**：脚本只监听AI生成完成事件，不会影响用户输入的消息
3. **智能检测**：如果消息已包含【前端占位符】，不会重复添加
4. **错误恢复**：即使处理出错也不会影响正常的聊天功能

## 更新日志

### v1.0.2 (2025-11-19)
- **区分自动和手动添加的提示信息**
- 自动添加时显示："自动添加界面成功！"（标题："自动检测完成"）
- 手动添加时显示："手动添加界面成功！"（标题："手动操作完成"）
- 优化错误提示，区分自动和手动操作的错误信息
- 增强控制台日志，明确显示操作模式

### v1.0.1 (2025-11-19)
- **修复消息ID范围错误问题**
- 增强消息ID验证和错误处理
- 当指定消息ID无效时自动回退到最新消息
- 增加更详细的控制台日志输出
- 优化用户体验和错误提示

### v1.0.0 (2025-11-19)
- 初始版本发布
- 支持自动检测和添加【前端占位符】
- 支持手动检查功能
- 完善的错误处理和用户提示
- 遵循项目代码规范

## 常见问题

### Q: 控制台出现"提供的消息范围 range 无效"错误怎么办？
A: 这已在v1.0.1版本中修复。脚本现在会：
1. 验证消息ID的有效性
2. 当指定的消息ID无效时自动使用最新消息
3. 在控制台输出详细的调试信息

### Q: 脚本不工作怎么办？
A: 请检查：
1. 确保使用的是v1.0.1或更新版本
2. 查看浏览器控制台是否有错误信息
3. 尝试点击"检查占位符"按钮手动触发
4. 确保酒馆助手已正确加载API函数