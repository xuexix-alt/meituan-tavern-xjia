{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/src/图片缓存管理器/图片缓存管理.ts","src://tavern_helper_template/src/图片缓存管理器/加载和卸载时执行函数.ts"],"sourcesContent":["// ✅ 图片缓存管理器 - 全局单例模式\n// 负责管理所有角色图片的缓存，避免重复加载\n\n// 状态管理\nexport let imageCache = new Map<string, string[]>(); // key: 角色名, value: base64图片列表\nexport let isPreloading = false;\nexport let imagesLoaded = false;\n\n/**\n * 初始化图片缓存系统\n */\nexport const initImageCache = async () => {\n  // 检查是否已经加载过\n  if (imagesLoaded || imageCache.size > 0) {\n    console.log('[图片缓存] 缓存已存在，跳过加载');\n    return;\n  }\n\n  if (isPreloading) {\n    console.log('[图片缓存] 正在加载中，跳过重复请求');\n    return;\n  }\n\n  isPreloading = true;\n  console.log('[图片缓存] 开始加载 image 目录...');\n\n  try {\n    // 获取GitHub图片列表\n    const response = await fetch('https://api.github.com/repos/xuexix-alt/meituan-tavern-xjia/contents/image');\n    const files = await response.json();\n\n    // 过滤图片文件\n    const imageFiles = files.filter(\n      (file: any) =>\n        file.name.toLowerCase().endsWith('.png') ||\n        file.name.toLowerCase().endsWith('.jpg') ||\n        file.name.toLowerCase().endsWith('.jpeg'),\n    );\n\n    console.log(`[图片缓存] 发现 ${imageFiles.length} 张图片`);\n\n    // 按角色名分组\n    const groupedImages = groupImagesByRole(imageFiles);\n\n    // 加载每组图片\n    await Promise.all(\n      Object.entries(groupedImages).map(async ([imageRoleName, fileNames]) => {\n        console.log(`[图片缓存] 加载角色 \"${imageRoleName}\" 的 ${fileNames.length} 张图片`);\n        await loadImagesForRole(imageRoleName, fileNames);\n      }),\n    );\n\n    console.log(`[图片缓存] 加载完成！缓存了 ${imageCache.size} 个角色的图片（内存缓存）`);\n    imagesLoaded = true;\n    isPreloading = false;\n  } catch (e) {\n    console.error('[图片缓存] 加载失败:', e);\n    isPreloading = false;\n  }\n};\n\n/**\n * 按角色名分组图片\n */\nconst groupImagesByRole = (imageFiles: any[]): Record<string, string[]> => {\n  const grouped: Record<string, string[]> = {};\n\n  imageFiles.forEach(file => {\n    const roleName = extractImageRoleName(file.name);\n    if (!grouped[roleName]) {\n      grouped[roleName] = [];\n    }\n    grouped[roleName].push(file.name);\n  });\n\n  return grouped;\n};\n\n/**\n * 从文件名提取角色名\n */\nconst extractImageRoleName = (fileName: string): string => {\n  let name = fileName.replace(/\\.(png|jpg|jpeg)$/i, '');\n  name = name.replace(/\\d+$/, '');\n  return name;\n};\n\n/**\n * 加载某个角色的所有图片\n */\nconst loadImagesForRole = async (imageRoleName: string, fileNames: string[]): Promise<void> => {\n  const base64Images: string[] = [];\n\n  await Promise.all(\n    fileNames.map(async fileName => {\n      const base64 = await loadImageAsBase64(fileName);\n      if (base64) {\n        base64Images.push(base64);\n        console.log(`[图片缓存] ${imageRoleName}: ${fileName}`);\n      }\n    }),\n  );\n\n  if (base64Images.length > 0) {\n    imageCache.set(imageRoleName, base64Images);\n  }\n};\n\n/**\n * 将图片加载为base64编码\n */\nconst loadImageAsBase64 = async (fileName: string): Promise<string | null> => {\n  return new Promise(resolve => {\n    const CDN_PREFIX = 'https://testingcf.jsdelivr.net/gh/xuexix-alt/meituan-tavern-xjia@main/image';\n    const url = `${CDN_PREFIX}/${fileName}`;\n\n    const img = new Image();\n    img.crossOrigin = 'anonymous';\n\n    img.onload = () => {\n      try {\n        const canvas = document.createElement('canvas');\n        canvas.width = img.width;\n        canvas.height = img.height;\n        const ctx = canvas.getContext('2d');\n        ctx?.drawImage(img, 0, 0);\n\n        // JPEG压缩，PNG保持原格式\n        const isJpeg = fileName.toLowerCase().endsWith('.jpg') || fileName.toLowerCase().endsWith('.jpeg');\n\n        const dataUrl = isJpeg ? canvas.toDataURL('image/jpeg', 0.7) : canvas.toDataURL('image/png');\n\n        resolve(dataUrl);\n      } catch (e) {\n        console.warn(`[图片缓存] 转换失败: ${fileName}`, e);\n        resolve(null);\n      }\n    };\n\n    img.onerror = () => {\n      console.log(`[图片缓存] 跳过不存在的图片: ${fileName}`);\n      resolve(null);\n    };\n\n    img.src = url;\n  });\n};\n\n/**\n * 获取角色的随机图片\n * @param roleName 角色名\n * @returns base64编码的图片字符串\n */\nexport const getRandomImageForRole = (roleName: string): string | null => {\n  if (!imagesLoaded) {\n    console.log(`[图片缓存] 缓存未加载完成`);\n    return null;\n  }\n\n  const images = imageCache.get(roleName);\n  if (!images || images.length === 0) {\n    console.log(`[图片缓存] 角色 \"${roleName}\" 无缓存图片`);\n    return null;\n  }\n\n  // 随机选择一张\n  const randomIndex = Math.floor(Math.random() * images.length);\n  const selectedImage = images[randomIndex];\n  console.log(`[图片缓存] 为 \"${roleName}\" 随机选择第 ${randomIndex + 1} 张图片（共 ${images.length} 张）`);\n  return selectedImage;\n};\n\n/**\n * 检查缓存是否加载完成\n */\nexport const isCacheLoaded = (): boolean => {\n  return imagesLoaded;\n};\n\n/**\n * 清除缓存（用于调试或重置）\n */\nexport const clearCache = () => {\n  imageCache.clear();\n  imagesLoaded = false;\n  console.log('[图片缓存] 内存缓存已清除（不再使用localStorage）');\n};\n","// ✅ 加载和卸载时的执行函数\nimport { initImageCache, clearCache } from './图片缓存管理';\n\n$(() => {\n  console.log('[图片缓存管理器] 脚本启动');\n\n  // 初始化图片缓存\n  (async () => {\n    await initImageCache();\n\n    // 尝试共享到全局接口（可能无效，但不影响主功能）\n    if (typeof initializeGlobal === 'function') {\n      try {\n        initializeGlobal('ImageCache', {\n          getImage: (roleName: string) => getRandomImageForRole(roleName),\n          isLoaded: () => isCacheLoaded(),\n          getStatus: () => ({\n            loaded: isCacheLoaded(),\n            rolesCount: imageCache.size,\n            totalImages: Array.from(imageCache.values()).reduce((acc, imgs) => acc + imgs.length, 0),\n          }),\n        });\n        console.log('[图片缓存] 已共享到全局接口 ImageCache');\n      } catch (e) {\n        console.warn('[图片缓存] 共享全局接口失败:', e);\n      }\n    } else {\n      console.log('[图片缓存] initializeGlobal 不可用，跳过全局共享');\n    }\n  })();\n\n  // 页面卸载时清理资源\n  $(window).on('pagehide', () => {\n    console.log('[图片缓存管理器] 脚本卸载');\n    // 注意：不清除缓存，保持持久化\n  });\n\n  // 开发者工具：全局暴露清除缓存函数（仅调试用）\n  (window as any).clearImageCache = () => {\n    clearCache();\n  };\n});\n"],"names":["Map","isPreloading","imagesLoaded","groupImagesByRole","imageFiles","grouped","forEach","file","roleName","extractImageRoleName","name","push","fileName","replace","loadImagesForRole","async","imageRoleName","fileNames","base64Images","Promise","all","map","base64","loadImageAsBase64","console","log","length","set","resolve","url","img","Image","crossOrigin","onload","canvas","document","createElement","width","height","ctx","getContext","drawImage","dataUrl","toLowerCase","endsWith","toDataURL","e","warn","onerror","src","$","size","response","fetch","json","filter","groupedImages","Object","entries","error","initImageCache","initializeGlobal","getImage","getRandomImageForRole","isLoaded","isCacheLoaded","getStatus","loaded","rolesCount","imageCache","totalImages","Array","from","values","reduce","acc","imgs","window","on","clearImageCache","clear"],"ignoreList":[],"sourceRoot":""}