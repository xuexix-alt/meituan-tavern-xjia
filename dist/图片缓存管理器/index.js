let e=new Map,o=!1,a=!1;const t=e=>{const o={};return e.forEach(e=>{const a=n(e.name);o[a]||(o[a]=[]),o[a].push(e.name)}),o},n=e=>{let o=e.replace(/\.(png|jpg|jpeg)$/i,'');return o=o.replace(/\d+$/,''),o},s=async(o,a)=>{const t=[];await Promise.all(a.map(async e=>{const a=await l(e);a&&(t.push(a),console.log(`[图片缓存] ${o}: ${e}`))})),t.length>0&&e.set(o,t)},l=async e=>new Promise(o=>{const a=`https://testingcf.jsdelivr.net/gh/xuexix-alt/meituan-tavern-xjia@main/image/${e}`,t=new Image;t.crossOrigin='anonymous',t.onload=()=>{try{const a=document.createElement('canvas');a.width=t.width,a.height=t.height;const n=a.getContext('2d');n?.drawImage(t,0,0);const s=e.toLowerCase().endsWith('.jpg')||e.toLowerCase().endsWith('.jpeg')?a.toDataURL('image/jpeg',.7):a.toDataURL('image/png');o(s)}catch(a){console.warn(`[图片缓存] 转换失败: ${e}`,a),o(null)}},t.onerror=()=>{console.log(`[图片缓存] 跳过不存在的图片: ${e}`),o(null)},t.src=a});$(()=>{console.log('[图片缓存管理器] 脚本启动'),(async()=>{if(await(async()=>{if(a||e.size>0)console.log('[图片缓存] 缓存已存在，跳过加载');else if(o)console.log('[图片缓存] 正在加载中，跳过重复请求');else{o=!0,console.log('[图片缓存] 开始加载 image 目录...');try{const n=await fetch('https://api.github.com/repos/xuexix-alt/meituan-tavern-xjia/contents/image'),l=(await n.json()).filter(e=>e.name.toLowerCase().endsWith('.png')||e.name.toLowerCase().endsWith('.jpg')||e.name.toLowerCase().endsWith('.jpeg'));console.log(`[图片缓存] 发现 ${l.length} 张图片`);const i=t(l);await Promise.all(Object.entries(i).map(async([e,o])=>{console.log(`[图片缓存] 加载角色 "${e}" 的 ${o.length} 张图片`),await s(e,o)})),console.log(`[图片缓存] 加载完成！缓存了 ${e.size} 个角色的图片（内存缓存）`),a=!0,o=!1}catch(e){console.error('[图片缓存] 加载失败:',e),o=!1}}})(),'function'==typeof initializeGlobal)try{initializeGlobal('ImageCache',{getImage:e=>getRandomImageForRole(e),isLoaded:()=>isCacheLoaded(),getStatus:()=>({loaded:isCacheLoaded(),rolesCount:imageCache.size,totalImages:Array.from(imageCache.values()).reduce((e,o)=>e+o.length,0)})}),console.log('[图片缓存] 已共享到全局接口 ImageCache')}catch(e){console.warn('[图片缓存] 共享全局接口失败:',e)}else console.log('[图片缓存] initializeGlobal 不可用，跳过全局共享')})(),$(window).on('pagehide',()=>{console.log('[图片缓存管理器] 脚本卸载')}),window.clearImageCache=()=>{e.clear(),a=!1,console.log('[图片缓存] 内存缓存已清除（不再使用localStorage）')}});
//# sourceMappingURL=index.js.map