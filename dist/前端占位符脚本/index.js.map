{"version":3,"file":"index.js","mappings":"AAAA,MAAM,EAA+BA,ECQ/BC,EAAiB,EAAAD,EAAEE,OAAO,CAC9BC,QAAS,EAAAH,EAAEI,UAAUC,SAAQ,GAC7BC,iBAAkB,EAAAN,EAAEO,SAASF,QAAQ,WACrCG,YAAa,EAAAR,EAAEI,UAAUC,SAAQ,GACjCI,kBAAmB,EAAAT,EAAEI,UAAUC,SAAQ,KAGnCK,EAAWT,EAAeU,MAAMC,aAAa,CAAEC,KAAM,SAAUC,UAAWC,iBAKhF,SAASC,EAAoBC,GAC3B,OAAOA,EAAQC,SAASR,EAASJ,iBACnC,CAoCA,SAASa,IACP,IACE,MAAMC,EApBV,WACE,MAAMC,EAAYC,sBACZF,EAAWG,gBAAgBF,GAEjC,OAAKD,GAAgC,IAApBA,EAASI,OAInBJ,EAASK,IAAIC,IAAO,CACzBC,KAAMD,EAAIC,KACVC,QAASF,EAAIT,SAAW,GACxBY,GAAIH,EAAIG,MAND,EAQX,CAOqBC,GAEjB,GAAwB,IAApBV,EAASI,OAEX,OADAO,QAAQC,IAAI,sBACL,EAMT,GAF2BZ,EAASa,MAAMP,GAAOV,EAAoBU,EAAIE,UAIvE,OADAG,QAAQC,IAAI,4BACL,EAIT,GAAItB,EAASF,YAAa,CACxB,MAAM0B,EAAkBd,EAASK,IAAIC,IAAO,UACvCA,EACHE,QAASZ,EAAoBU,EAAIE,SAAWF,EAAIE,SApD7BA,EAoDyDF,EAAIE,QAlDlFA,EAAQO,SAAS,MACZP,EAAUlB,EAASJ,iBAAmB,KAIxCsB,EAAU,KAAOlB,EAASJ,iBAAmB,OAPtD,IAA2BsB,IAwDfQ,EAAgBhB,EAAS,GAAGS,GAG5BQ,EAAcH,EACjBT,IAAIC,GAAO,GAAgB,SAAbA,EAAIC,KAAkB,IAAMD,EAAIC,SAASD,EAAIE,WAC3DU,KAAK,QAUR,OAPAC,aAAa,WAAWH,KAAiBC,KAErC3B,EAASD,mBACX+B,OAAOC,QAAQ,mBAAoB,QAGrCV,QAAQC,IAAI,wBACL,CACT,CAEA,OAAO,CACT,CAAE,MAAOU,GAGP,OAFAX,QAAQW,MAAM,gBAAiBA,GAC/BF,OAAOE,MAAM,mBAAoB,SAC1B,CACT,CACF,CA2DO,SAASC,EAAeC,GAC7B,MAAMC,EAAU,IAAKnC,KAAakC,GAClCE,iBAAiBD,EAAS,CAAEhC,KAAM,SAAUC,UAAWC,gBAEnDL,EAASD,mBACX+B,OAAOC,QAAQ,QAAS,OAE5B,CAKO,SAASM,IACd,OAAO9C,EAAeU,MAAMC,aAAa,CAAEC,KAAM,SAAUC,UAAWC,gBACxE,CAxDAiC,EAAE,KACAjB,QAAQC,IAAI,iBAGRtB,EAASD,mBACX+B,OAAOS,KAAK,8BAA+B,UAS/CC,QAAQC,eAAe,SAAU,KAC/BpB,QAAQC,IAAI,mBA1BGb,KAEAT,EAASD,mBACtB+B,OAAOS,KAAK,kBAAmB,UA4BnCC,QAAQE,cAAcC,aAAehC,IAC/BX,EAASF,aAAeE,EAASP,UACnC4B,QAAQC,IAAI,uBAEZsB,WAAW,KACTnC,KACC,QAKP+B,QAAQE,cAAcG,aAAeC,IACnCzB,QAAQC,IAAI,iBAAkBwB,KA8BhCR,EAAES,QAAQC,GAAG,WAAY,KACvB3B,QAAQC,IAAI,0B","sources":["src://tavern_helper_template/external var \"z\"","src://tavern_helper_template/src/前端占位符脚本/index.ts"],"sourcesContent":["const __WEBPACK_NAMESPACE_OBJECT__ = z;","/**\n * 前端占位符检查与插入脚本\n * 功能：检查当前楼层消息中是否包含【前端占位符】，如果没有则自动插入\n */\n\nimport { z } from 'zod';\n\n// 脚本设置\nconst ScriptSettings = z.object({\n  enabled: z.boolean().default(true),\n  placeholder_text: z.string().default('【前端占位符】'),\n  auto_insert: z.boolean().default(true),\n  show_notification: z.boolean().default(true),\n});\n\nconst settings = ScriptSettings.parse(getVariables({ type: 'script', script_id: getScriptId() }));\n\n/**\n * 检查消息中是否包含占位符\n */\nfunction containsPlaceholder(message: string): boolean {\n  return message.includes(settings.placeholder_text);\n}\n\n/**\n * 在消息内容中插入占位符\n */\nfunction insertPlaceholder(content: string): string {\n  // 如果已经是最后一行，直接追加\n  if (content.endsWith('\\n')) {\n    return content + settings.placeholder_text + '\\n';\n  }\n\n  // 否则另起一行插入\n  return content + '\\n' + settings.placeholder_text + '\\n';\n}\n\n/**\n * 获取并解析当前楼层的所有消息\n */\nfunction getCurrentFloorMessages(): Array<{ role: string; content: string; id: string }> {\n  const messageId = getCurrentMessageId();\n  const messages = getChatMessages(messageId);\n\n  if (!messages || messages.length === 0) {\n    return [];\n  }\n\n  return messages.map(msg => ({\n    role: msg.role,\n    content: msg.message || '',\n    id: msg.id,\n  }));\n}\n\n/**\n * 检查当前楼层是否已有占位符\n */\nfunction checkAndInsertPlaceholder(): boolean {\n  try {\n    const messages = getCurrentFloorMessages();\n\n    if (messages.length === 0) {\n      console.log('[前端占位符] 当前楼层无消息内容');\n      return false;\n    }\n\n    // 检查所有消息是否都包含占位符\n    const allHavePlaceholder = messages.every(msg => containsPlaceholder(msg.content));\n\n    if (allHavePlaceholder) {\n      console.log('[前端占位符] 当前楼层已包含占位符，跳过插入');\n      return false;\n    }\n\n    // 如果没有占位符，则插入\n    if (settings.auto_insert) {\n      const updatedMessages = messages.map(msg => ({\n        ...msg,\n        content: containsPlaceholder(msg.content) ? msg.content : insertPlaceholder(msg.content),\n      }));\n\n      // 发送更新消息（使用第一个消息的ID作为基础）\n      const baseMessageId = messages[0].id;\n\n      // 构建完整消息内容\n      const fullContent = updatedMessages\n        .map(msg => `${msg.role === 'user' ? '你' : msg.role}: ${msg.content}`)\n        .join('\\n\\n');\n\n      // 使用triggerSlash发送更新命令\n      triggerSlash(`/chat u ${baseMessageId} ${fullContent}`);\n\n      if (settings.show_notification) {\n        toastr.success('[前端占位符] 已自动插入占位符', '脚本提示');\n      }\n\n      console.log('[前端占位符] 已插入占位符到当前楼层');\n      return true;\n    }\n\n    return false;\n  } catch (error) {\n    console.error('[前端占位符] 执行失败:', error);\n    toastr.error('前端占位符插入失败，请查看控制台', '脚本错误');\n    return false;\n  }\n}\n\n/**\n * 手动触发占位符检查\n */\nfunction manualCheck(): void {\n  const result = checkAndInsertPlaceholder();\n\n  if (!result && settings.show_notification) {\n    toastr.info('当前楼层已包含占位符，无需插入', '脚本提示');\n  }\n}\n\n// =============================================================================\n// 脚本初始化\n// =============================================================================\n\n$(() => {\n  console.log('[前端占位符] 脚本已加载');\n\n  // 注册手动检查按钮\n  if (settings.show_notification) {\n    toastr.info('点击下方\"检查占位符\"按钮手动执行，或启用自动插入模式', '脚本提示');\n  }\n});\n\n// =============================================================================\n// 事件监听\n// =============================================================================\n\n// 监听脚本按钮点击事件\neventOn(getButtonEvent('检查占位符'), () => {\n  console.log('[前端占位符] 手动检查触发');\n  manualCheck();\n});\n\n// 监听消息发送完成事件，在新消息产生后自动检查\neventOn(tavern_events.MESSAGE_SENT, (messageId: string) => {\n  if (settings.auto_insert && settings.enabled) {\n    console.log('[前端占位符] 消息发送完成，自动检查');\n    // 延迟执行，确保消息已保存\n    setTimeout(() => {\n      checkAndInsertPlaceholder();\n    }, 100);\n  }\n});\n\n// 监听聊天切换事件\neventOn(tavern_events.CHAT_CHANGED, (newChatId: string) => {\n  console.log('[前端占位符] 聊天切换到:', newChatId);\n});\n\n// =============================================================================\n// 导出设置更新函数\n// =============================================================================\n\n/**\n * 更新设置\n */\nexport function updateSettings(newSettings: Partial<ScriptSettings>): void {\n  const updated = { ...settings, ...newSettings };\n  replaceVariables(updated, { type: 'script', script_id: getScriptId() });\n\n  if (settings.show_notification) {\n    toastr.success('设置已更新', '脚本提示');\n  }\n}\n\n/**\n * 获取当前设置\n */\nexport function getSettings(): ScriptSettings {\n  return ScriptSettings.parse(getVariables({ type: 'script', script_id: getScriptId() }));\n}\n\n// =============================================================================\n// 页面卸载清理\n// =============================================================================\n\n$(window).on('pagehide', () => {\n  console.log('[前端占位符] 脚本已卸载');\n});\n\n// =============================================================================\n// 主动执行一次检查（可选，注释掉以禁用）\n// =============================================================================\n\n// 在脚本加载时主动检查一次\n// checkAndInsertPlaceholder();\n"],"names":["z","ScriptSettings","object","enabled","boolean","default","placeholder_text","string","auto_insert","show_notification","settings","parse","getVariables","type","script_id","getScriptId","containsPlaceholder","message","includes","checkAndInsertPlaceholder","messages","messageId","getCurrentMessageId","getChatMessages","length","map","msg","role","content","id","getCurrentFloorMessages","console","log","every","updatedMessages","endsWith","baseMessageId","fullContent","join","triggerSlash","toastr","success","error","updateSettings","newSettings","updated","replaceVariables","getSettings","$","info","eventOn","getButtonEvent","tavern_events","MESSAGE_SENT","setTimeout","CHAT_CHANGED","newChatId","window","on"],"ignoreList":[],"sourceRoot":""}