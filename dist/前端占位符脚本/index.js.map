{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/external var \"z\"","src://tavern_helper_template/src/前端占位符脚本/index.ts"],"sourcesContent":["const __WEBPACK_NAMESPACE_OBJECT__ = z;","/**\n * 前端占位符检查与插入脚本\n * 功能：检查当前楼层消息中是否包含【前端占位符】，如果没有则自动插入\n */\n\nimport { z } from 'zod';\n\n// 脚本设置\nconst ScriptSettings = z.object({\n  enabled: z.boolean().default(true),\n  placeholder_text: z.string().default('【前端占位符】'),\n  auto_insert: z.boolean().default(true),\n  show_notification: z.boolean().default(true),\n});\n\nconst settings = ScriptSettings.parse(getVariables({ type: 'script', script_id: getScriptId() }));\n\n// ================== 店铺持久化 ==================\ntype StoredShop = Record<string, any> & { id: string; packages?: any[]; __savedAt?: number };\nconst SHOP_STORE_KEY = 'shop_store_cache';\nconst MAX_SHOP_COUNT = 10;\n\nfunction readShopStore(): StoredShop[] {\n  try {\n    const vars = getVariables({ type: 'script', script_id: getScriptId() }) || {};\n    const list = (vars as any)[SHOP_STORE_KEY];\n    return Array.isArray(list) ? list : [];\n  } catch (e) {\n    console.warn('[ShopStore] 读取失败', e);\n    return [];\n  }\n}\n\nfunction writeShopStore(shops: StoredShop[]) {\n  try {\n    replaceVariables({ [SHOP_STORE_KEY]: shops }, { type: 'script', script_id: getScriptId() });\n  } catch (e) {\n    console.warn('[ShopStore] 写入失败', e);\n  }\n}\n\nfunction normalizeShops(raw: any[]): StoredShop[] {\n  if (!Array.isArray(raw)) return [];\n  return raw\n    .filter(s => s && s.id)\n    .map(s => ({\n      ...s,\n      id: String(s.id), // 统一为字符串，便于路由匹配\n      __savedAt: Date.now(),\n    }));\n}\n\nfunction mergeAndCap(shops: StoredShop[], incoming: StoredShop[]): StoredShop[] {\n  const map = new Map<string, StoredShop>();\n  // 先放新数据，后放旧数据；同 id 以新覆盖\n  [...incoming, ...shops].forEach(s => {\n    if (!map.has(s.id)) map.set(s.id, s);\n  });\n  const result = Array.from(map.values())\n    .sort((a, b) => (b.__savedAt || 0) - (a.__savedAt || 0))\n    .slice(0, MAX_SHOP_COUNT);\n  return result;\n}\n\nfunction saveShopsToStore(newShops: any[]) {\n  const existing = readShopStore();\n  const incoming = normalizeShops(newShops);\n  const merged = mergeAndCap(existing, incoming);\n  writeShopStore(merged);\n  return merged;\n}\n\nfunction deleteShopFromStore(shopId: string) {\n  const existing = readShopStore();\n  const filtered = existing.filter(s => s.id !== shopId);\n  writeShopStore(filtered);\n  return filtered;\n}\n\nfunction getStoreApi() {\n  return {\n    getShops: () => readShopStore(),\n    saveShops: (shops: any[]) => saveShopsToStore(shops),\n    deleteShop: (id: string) => deleteShopFromStore(id),\n    clear: () => writeShopStore([]),\n  };\n}\n\n/**\n * 检查消息中是否包含占位符\n */\nfunction containsPlaceholder(message: string): boolean {\n  return message.includes(settings.placeholder_text);\n}\n\n/**\n * 在消息内容中插入占位符\n */\nfunction insertPlaceholder(content: string): string {\n  // 如果已经是最后一行，直接追加\n  if (content.endsWith('\\n')) {\n    return content + settings.placeholder_text + '\\n';\n  }\n\n  // 否则另起一行插入\n  return content + '\\n' + settings.placeholder_text + '\\n';\n}\n\n/**\n * 获取并解析当前楼层的所有消息\n */\nfunction getCurrentFloorMessages(): Array<{ role: string; content: string; id: string }> {\n  const messageId = getCurrentMessageId();\n  const messages = getChatMessages(messageId);\n\n  if (!messages || messages.length === 0) {\n    return [];\n  }\n\n  return messages.map(msg => ({\n    role: msg.role,\n    content: msg.message || '',\n    id: msg.id,\n  }));\n}\n\n/**\n * 检查当前楼层是否已有占位符\n */\nfunction checkAndInsertPlaceholder(options: { silent?: boolean } = {}): boolean {\n  const { silent = false } = options;\n  try {\n    const messages = getCurrentFloorMessages();\n\n    if (messages.length === 0) {\n      console.log('[前端占位符] 当前楼层无消息内容');\n      return false;\n    }\n\n    // 检查所有消息是否都包含占位符\n    const allHavePlaceholder = messages.every(msg => containsPlaceholder(msg.content));\n\n    if (allHavePlaceholder) {\n      console.log('[前端占位符] 当前楼层已包含占位符，跳过插入');\n      return false;\n    }\n\n    // 如果没有占位符，则插入\n    if (settings.auto_insert) {\n      const updatedMessages = messages.map(msg => ({\n        ...msg,\n        content: containsPlaceholder(msg.content) ? msg.content : insertPlaceholder(msg.content),\n      }));\n\n      // 发送更新消息（使用第一个消息的ID作为基础）\n      const baseMessageId = messages[0].id;\n\n      // 构建完整消息内容\n      const fullContent = updatedMessages\n        .map(msg => `${msg.role === 'user' ? '你' : msg.role}: ${msg.content}`)\n        .join('\\n\\n');\n\n      // 使用triggerSlash发送更新命令\n      triggerSlash(`/chat u ${baseMessageId} ${fullContent}`);\n\n      if (settings.show_notification && !silent) {\n        toastr.success('[前端占位符] 已自动插入占位符', '脚本提示');\n      }\n\n      console.log('[前端占位符] 已插入占位符到当前楼层');\n      return true;\n    }\n\n    return false;\n  } catch (error) {\n    console.error('[前端占位符] 执行失败:', error);\n    if (!silent) {\n      toastr.error('前端占位符插入失败，请查看控制台', '脚本错误');\n    }\n    return false;\n  }\n}\n\n/**\n * 手动触发占位符检查\n */\nfunction manualCheck(): void {\n  const result = checkAndInsertPlaceholder();\n\n  if (!result && settings.show_notification) {\n    toastr.info('当前楼层已包含占位符，无需插入', '脚本提示');\n  }\n}\n\n// =============================================================================\n// 脚本初始化\n// =============================================================================\n\n$(() => {\n  console.log('[前端占位符] 脚本已加载');\n\n  // 注册手动检查按钮\n  if (settings.show_notification) {\n    toastr.info('点击下方\"检查占位符\"按钮手动执行，或启用自动插入模式', '脚本提示');\n  }\n\n  // 暴露店铺存储接口\n  try {\n    initializeGlobal('ShopStore', getStoreApi());\n    console.log('[ShopStore] 已共享全局接口');\n  } catch (e) {\n    console.warn('[ShopStore] 共享全局接口失败', e);\n  }\n});\n\n// =============================================================================\n// 事件监听\n// =============================================================================\n\n// 监听脚本按钮点击事件\neventOn(getButtonEvent('检查占位符'), () => {\n  console.log('[前端占位符] 手动检查触发');\n  manualCheck();\n});\n\n// 店铺存储快捷按钮\neventOn(getButtonEvent('查看已存店铺'), () => {\n  const api = getStoreApi();\n  if (!api) return toastr.warning('ShopStore 未初始化', '店铺存储');\n  const list = api.getShops();\n  console.log('[ShopStore] 当前店铺列表:', list);\n  toastr.info(`已存 ${list.length} 个店铺`, '店铺存储');\n});\n\neventOn(getButtonEvent('清空店铺缓存'), () => {\n  const api = getStoreApi();\n  if (!api) return toastr.warning('ShopStore 未初始化', '店铺存储');\n  api.clear();\n  toastr.success('店铺缓存已清空', '店铺存储');\n});\n\neventOn(getButtonEvent('导出店铺JSON'), () => {\n  const api = getStoreApi();\n  if (!api) return toastr.warning('ShopStore 未初始化', '店铺存储');\n  const list = api.getShops();\n  console.log('[ShopStore] 导出 JSON:', JSON.stringify(list, null, 2));\n  toastr.info('JSON 已输出到控制台', '店铺存储');\n});\n\n// 监听消息发送完成事件，在新消息产生后自动检查\neventOn(tavern_events.MESSAGE_SENT, (messageId: string) => {\n  if (settings.auto_insert && settings.enabled) {\n    console.log('[前端占位符] 消息发送完成，自动检查');\n    // 延迟执行，确保消息已保存\n    setTimeout(() => {\n      // 静默模式，避免订单类系统消息触发提示/报错\n      checkAndInsertPlaceholder({ silent: true });\n    }, 100);\n  }\n});\n\n// 监听聊天切换事件\neventOn(tavern_events.CHAT_CHANGED, (newChatId: string) => {\n  console.log('[前端占位符] 聊天切换到:', newChatId);\n});\n\n// =============================================================================\n// 导出设置更新函数\n// =============================================================================\n\n/**\n * 更新设置\n */\nexport function updateSettings(newSettings: Partial<ScriptSettings>): void {\n  const updated = { ...settings, ...newSettings };\n  replaceVariables(updated, { type: 'script', script_id: getScriptId() });\n\n  if (settings.show_notification) {\n    toastr.success('设置已更新', '脚本提示');\n  }\n}\n\n/**\n * 获取当前设置\n */\nexport function getSettings(): ScriptSettings {\n  return ScriptSettings.parse(getVariables({ type: 'script', script_id: getScriptId() }));\n}\n\n// =============================================================================\n// 页面卸载清理\n// =============================================================================\n\n$(window).on('pagehide', () => {\n  console.log('[前端占位符] 脚本已卸载');\n});\n\n// =============================================================================\n// 主动执行一次检查（可选，注释掉以禁用）\n// =============================================================================\n\n// 在脚本加载时主动检查一次\n// checkAndInsertPlaceholder();\n"],"names":["z","ScriptSettings","object","enabled","boolean","default","placeholder_text","string","auto_insert","show_notification","settings","parse","getVariables","type","script_id","getScriptId","SHOP_STORE_KEY","readShopStore","list","Array","isArray","e","console","warn","writeShopStore","shops","replaceVariables","saveShopsToStore","newShops","raw","merged","incoming","map","Map","forEach","s","has","id","set","from","values","sort","a","b","__savedAt","slice","mergeAndCap","filter","String","Date","now","getStoreApi","getShops","saveShops","deleteShop","shopId","filtered","deleteShopFromStore","clear","containsPlaceholder","message","includes","checkAndInsertPlaceholder","options","silent","messages","messageId","getCurrentMessageId","getChatMessages","length","msg","role","content","getCurrentFloorMessages","log","every","updatedMessages","endsWith","baseMessageId","fullContent","join","triggerSlash","toastr","success","error","updateSettings","newSettings","updated","getSettings","$","info","initializeGlobal","eventOn","getButtonEvent","api","warning","JSON","stringify","tavern_events","MESSAGE_SENT","setTimeout","CHAT_CHANGED","newChatId","window","on"],"ignoreList":[],"sourceRoot":""}