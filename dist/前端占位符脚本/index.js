const t=z,e=t.z.object({enabled:t.z.boolean().default(!0),placeholder_text:t.z.string().default('【前端占位符】'),auto_insert:t.z.boolean().default(!0),show_notification:t.z.boolean().default(!0)}),o=e.parse(getVariables({type:'script',script_id:getScriptId()})),n='shop_store_cache';function r(){try{const t=(getVariables({type:'script',script_id:getScriptId()})||{})[n];return Array.isArray(t)?t:[]}catch(t){return console.warn('[ShopStore] 读取失败',t),[]}}function s(t){try{replaceVariables({[n]:t},{type:'script',script_id:getScriptId()})}catch(t){console.warn('[ShopStore] 写入失败',t)}}function i(t){var e;const o=function(t,e){const o=new Map;return[...e,...t].forEach(t=>{o.has(t.id)||o.set(t.id,t)}),Array.from(o.values()).sort((t,e)=>(e.__savedAt||0)-(t.__savedAt||0)).slice(0,10)}(r(),(e=t,Array.isArray(e)?e.filter(t=>t&&t.id).map(t=>({...t,id:String(t.id),__savedAt:Date.now()})):[]));return s(o),o}function c(){return{getShops:()=>r(),saveShops:t=>i(t),deleteShop:t=>function(t){const e=r().filter(e=>e.id!==t);return s(e),e}(t),clear:()=>s([])}}function a(t){return t.includes(o.placeholder_text)}function l(t={}){const{silent:e=!1}=t;try{const t=function(){const t=getCurrentMessageId(),e=getChatMessages(t);return e&&0!==e.length?e.map(t=>({role:t.role,content:t.message||'',id:t.id})):[]}();if(0===t.length)return console.log('[前端占位符] 当前楼层无消息内容'),!1;if(t.every(t=>a(t.content)))return console.log('[前端占位符] 当前楼层已包含占位符，跳过插入'),!1;if(o.auto_insert){const n=t.map(t=>{return{...t,content:a(t.content)?t.content:(e=t.content,e.endsWith('\n')?e+o.placeholder_text+'\n':e+'\n'+o.placeholder_text+'\n')};var e}),r=t[0].id,s=n.map(t=>`${'user'===t.role?'你':t.role}: ${t.content}`).join('\n\n');return triggerSlash(`/chat u ${r} ${s}`),o.show_notification&&!e&&toastr.success('[前端占位符] 已自动插入占位符','脚本提示'),console.log('[前端占位符] 已插入占位符到当前楼层'),!0}return!1}catch(t){return console.error('[前端占位符] 执行失败:',t),e||toastr.error('前端占位符插入失败，请查看控制台','脚本错误'),!1}}function p(t){const e={...o,...t};replaceVariables(e,{type:'script',script_id:getScriptId()}),o.show_notification&&toastr.success('设置已更新','脚本提示')}function u(){return e.parse(getVariables({type:'script',script_id:getScriptId()}))}$(()=>{console.log('[前端占位符] 脚本已加载'),o.show_notification&&toastr.info('点击下方"检查占位符"按钮手动执行，或启用自动插入模式','脚本提示');try{initializeGlobal('ShopStore',c()),console.log('[ShopStore] 已共享全局接口')}catch(t){console.warn('[ShopStore] 共享全局接口失败',t)}}),eventOn(getButtonEvent('检查占位符'),()=>{console.log('[前端占位符] 手动检查触发'),!l()&&o.show_notification&&toastr.info('当前楼层已包含占位符，无需插入','脚本提示')}),eventOn(getButtonEvent('查看已存店铺'),()=>{const t=c();if(!t)return toastr.warning('ShopStore 未初始化','店铺存储');const e=t.getShops();console.log('[ShopStore] 当前店铺列表:',e),toastr.info(`已存 ${e.length} 个店铺`,'店铺存储')}),eventOn(getButtonEvent('清空店铺缓存'),()=>{const t=c();if(!t)return toastr.warning('ShopStore 未初始化','店铺存储');t.clear(),toastr.success('店铺缓存已清空','店铺存储')}),eventOn(getButtonEvent('导出店铺JSON'),()=>{const t=c();if(!t)return toastr.warning('ShopStore 未初始化','店铺存储');const e=t.getShops();console.log('[ShopStore] 导出 JSON:',JSON.stringify(e,null,2)),toastr.info('JSON 已输出到控制台','店铺存储')}),eventOn(tavern_events.MESSAGE_SENT,t=>{o.auto_insert&&o.enabled&&(console.log('[前端占位符] 消息发送完成，自动检查'),setTimeout(()=>{l({silent:!0})},100))}),eventOn(tavern_events.CHAT_CHANGED,t=>{console.log('[前端占位符] 聊天切换到:',t)}),$(window).on('pagehide',()=>{console.log('[前端占位符] 脚本已卸载')});export{u as getSettings,p as updateSettings};
//# sourceMappingURL=index.js.map