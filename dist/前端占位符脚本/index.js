const t=z,e=t.z.object({enabled:t.z.boolean().default(!0),placeholder_text:t.z.string().default('【前端占位符】'),auto_insert:t.z.boolean().default(!0),show_notification:t.z.boolean().default(!0),keep_cross_chat:t.z.boolean().default(!0)}),o=e.parse(getVariables({type:'script',script_id:getScriptId()})),n='shop_store_cache';function r(t,e){try{window.dispatchEvent(new CustomEvent(t,{detail:e}))}catch(t){console.warn('[ShopStore] 事件派发失败',t)}}function s(t){let e=0;for(let o=0;o<t.length;o++)e=(e+t.charCodeAt(o))%65536;return e.toString(16)}function c(){if(o.keep_cross_chat)return{type:'global'};const t=SillyTavern.getCurrentChatId?.();return t?{type:'chat',chat_id:t}:{type:'global'}}function a(){try{const t=(getVariables(c())||{})[n];return console.log('[ShopStore] 读取全局缓存:',t),Array.isArray(t)?t:[]}catch(t){return console.warn('[ShopStore] 读取失败',t),[]}}function i(t){try{console.log('[ShopStore] 写入全局缓存:',t),replaceVariables({[n]:t},c()),r('shop:cache:updated',{scope:c(),count:t.length,op:'write'})}catch(t){console.warn('[ShopStore] 写入失败',t)}}function l(t){return Array.isArray(t)?t.filter(t=>!!t).slice(0,200).map(t=>{const e=function(t){return t?.id?String(t.id):t?.shop_id?String(t.shop_id):`shop_${function(t){let e=0;for(let o=0;o<t.length;o++)e=31*e+t.charCodeAt(o)>>>0;return e.toString(16)}([t?.name,t?.address,t?.city].filter(Boolean).join('|')||JSON.stringify(t||{}))}`}(t);return{...t,id:e,__savedAt:Date.now()}}):[]}function h(){return{getShops:()=>a(),saveShops:t=>function(t){const e=a(),o=l(t);if(0===o.length)return e;const n=new Map;e.forEach(t=>n.set(t.id,t)),o.forEach(t=>n.set(t.id,t));const r=Array.from(n.values());return i(r),r}(t),deleteShop:t=>function(t){const e=a().filter(e=>e.id!==t);return i(e),r('shop:cache:updated',{scope:c(),count:e.length,op:'delete',id:t}),e}(t),clear:()=>{i([]),r('shop:cache:updated',{scope:c(),count:0,op:'clear'})}}}function p(t){return t.includes(o.placeholder_text)}function u(t={}){const{silent:e=!1}=t;try{const t=function(){const t=getCurrentMessageId(),e=getChatMessages(t);return e&&0!==e.length?e.map(t=>({role:t.role,content:t.message||'',id:t.id||''})):[]}();if(0===t.length)return console.log('[前端占位符] 当前楼层无消息内容'),!1;if(t.every(t=>p(t.content)))return console.log('[前端占位符] 当前楼层已包含占位符，跳过插入'),!1;if(o.auto_insert){const n=t.map(t=>{return{...t,content:p(t.content)?t.content:(e=t.content,e.endsWith('\n')?e+o.placeholder_text+'\n':e+'\n'+o.placeholder_text+'\n')};var e}),r=t[0].id,s=n.map(t=>`${'user'===t.role?'你':t.role}: ${t.content}`).join('\n\n');return triggerSlash(`/chat u ${r} ${s}`),o.show_notification&&!e&&toastr.success('[前端占位符] 已自动插入占位符','脚本提示'),console.log('[前端占位符] 已插入占位符到当前楼层'),!0}return!1}catch(t){return console.error('[前端占位符] 执行失败:',t),e||toastr.error('前端占位符插入失败，请查看控制台','脚本错误'),!1}}$(()=>{console.log('[前端占位符] 脚本已加载'),o.show_notification&&toastr.info('点击下方"检查占位符"按钮手动执行，或启用自动插入模式','脚本提示');try{initializeGlobal('ShopStore',h()),console.log('[ShopStore] 已共享全局接口')}catch(t){console.warn('[ShopStore] 共享全局接口失败',t)}}),eventOn(getButtonEvent('检查占位符'),()=>{console.log('[前端占位符] 手动检查触发'),!u()&&o.show_notification&&toastr.info('当前楼层已包含占位符，无需插入','脚本提示')}),eventOn(getButtonEvent('查看已存店铺'),()=>{const t=h();if(!t)return void toastr.warning('ShopStore 未初始化','店铺存储');const e=t.getShops();console.log('[ShopStore] 当前店铺列表:',e),toastr.info(`已存 ${e.length} 个店铺`,'店铺存储')}),eventOn(getButtonEvent('清空店铺缓存'),()=>{const t=h();t?(t.clear(),toastr.success('店铺缓存已清空','店铺存储')):toastr.warning('ShopStore 未初始化','店铺存储')}),eventOn(getButtonEvent('导出店铺JSON'),()=>{const t=h();if(!t)return void toastr.warning('ShopStore 未初始化','店铺存储');const e=t.getShops(),o={version:'v1',generatedAt:(new Date).toISOString(),checksum:s(JSON.stringify(e)),shops:e},n=JSON.stringify(o,null,2);console.log('[ShopStore] 导出 JSON:',n);try{const t=new Blob([n],{type:'application/json'}),o=URL.createObjectURL(t),r=(window.top||window).document,s=r.createElement('a'),c=new Date,a=t=>`${t}`.padStart(2,'0'),i=`${c.getFullYear()}${a(c.getMonth()+1)}${a(c.getDate())}_${a(c.getHours())}${a(c.getMinutes())}${a(c.getSeconds())}`;s.href=o,s.download=`shops_${i}.json`,r.body.appendChild(s),s.click(),s.remove(),setTimeout(()=>URL.revokeObjectURL(o),3e3),toastr.success(`已保存 ${e.length} 家店铺为文件 shops_${i}.json`,'店铺存储')}catch(t){try{const t=`data:application/json;charset=utf-8,${encodeURIComponent(n)}`;window.open(t,'_blank'),toastr.info(`已在新标签页打开 JSON（共 ${e.length} 家）`,'店铺存储')}catch(t){console.warn('[ShopStore] 文件导出失败，已退回控制台输出',t),toastr.warning('文件导出失败，已在控制台输出 JSON','店铺存储')}}}),eventOn(getButtonEvent('切换店铺跨聊天保留'),()=>{const t={...o,keep_cross_chat:!o.keep_cross_chat};replaceVariables(t,{type:'script',script_id:getScriptId()}),o.keep_cross_chat=t.keep_cross_chat,i([]),toastr.success('跨聊天保留店铺：'+(t.keep_cross_chat?'开启':'关闭'),'店铺存储')}),eventOn(tavern_events.MESSAGE_SENT,t=>{o.auto_insert&&o.enabled&&(console.log('[前端占位符] 消息发送完成，自动检查'),setTimeout(()=>{u({silent:!0})},100))}),eventOn(tavern_events.CHAT_CHANGED,t=>{console.log('[前端占位符] 聊天切换到:',t)}),$(window).on('pagehide',()=>{console.log('[前端占位符] 脚本已卸载')});