{"version":3,"file":"index.js","mappings":"gBACAA,EAAE,KACAC,OAAOC,QAAQ,gBAAiB,UAIlCF,EAAEG,QAAQC,GAAG,WAAY,KACvBH,OAAOI,KAAK,gBAAiB,S,GCN3BC,EAA2B,CAAC,GAGhC,SAASC,EAAoBC,GAE5B,IAAIC,EAAeH,EAAyBE,GAC5C,QAAqBE,IAAjBD,EACH,OAAOA,EAAaE,QAGrB,IAAIC,EAASN,EAAyBE,GAAY,CAGjDG,QAAS,CAAC,GAOX,OAHAE,EAAoBL,GAAUI,EAAQA,EAAOD,QAASJ,GAG/CK,EAAOD,OACf,E,MCTAG,eAAeC,EAAuBC,EAAoBC,EAA0B,QAClF,IACE,MAAMC,EAAoB,SAATD,EAAkB,KAAO,KAI1C,GAHAE,QAAQC,IAAI,WAAWF,QAAeF,SAGZ,iBAAfA,GAA2BA,EAAa,EAEjD,YADAG,QAAQC,IAAI,oBAAoBJ,KAKlC,IAAIK,EACJ,IACEA,EAAWC,gBAAgBN,EAAWO,WACxC,CAAE,MAAOC,GACPL,QAAQC,IAAI,gBAAgBJ,mBAE5BK,EAAWC,iBAAiB,GACxBD,GAAYA,EAASI,OAAS,IAChCT,EAAaK,EAAS,GAAGL,WACzBG,QAAQC,IAAI,aAAaF,YAAmBF,OAEhD,CAEA,IAAKK,GAAgC,IAApBA,EAASI,OAExB,YADAN,QAAQC,IAAI,oBAId,MAAMM,EAAUL,EAAS,GACnBM,EAAc,UAGpB,GAAKD,EAAQA,QAAQE,SAASD,GAqB5BR,QAAQC,IAAI,aAAaJ,eAAwBE,WArBP,CAE1C,MAAMW,EAAaH,EAAQA,QAAU,KAAOC,QAGtCG,gBAAgB,CACpB,CACEd,WAAYA,EACZU,QAASG,KAKA,SAATZ,EACFhB,OAAOC,QAAQ,YAAa,UAE5BD,OAAOC,QAAQ,YAAa,UAG9BiB,QAAQC,IAAI,WAAWF,QAAeF,WACxC,CAGF,CAAE,MAAOe,GAEP,MAAMb,EAAoB,SAATD,EAAkB,KAAO,KAC1ChB,OAAO8B,MAAM,GAAGb,QAAeF,aAAsBe,IAAS,GAAGb,SACjEC,QAAQY,MAAM,WAAWb,QAAeF,YAAsBe,EAChE,CACF,CA3EAC,QAAQC,cAAcC,iBAAkBpB,MAAOE,IAE7CmB,WAAWrB,gBACHC,EAAuBC,IAC5B,OCFLhB,EAAE,KAEAoC,qBAAqB,CAAC,CAAEC,KAAM,QAASC,SAAS,KAGhDN,QAAQO,eAAe,SAAUzB,UAC/Bb,OAAOI,KAAK,kBAAmB,aDwE5BS,iBACL,IACEK,QAAQC,IAAI,oBACZ,MAAMJ,EAAawB,mBAGnB,GAFArB,QAAQC,IAAI,sBAAsBJ,KAEf,IAAfA,EAEF,YADAf,OAAOwC,QAAQ,WAAY,YAIvB1B,EAAuBC,EAAY,SAC3C,CAAE,MAAOe,GACP9B,OAAO8B,MAAM,cAAcA,IAAS,UACpCZ,QAAQY,MAAM,qBAAsBA,EACtC,CACF,CCvFUW","sources":["src://tavern_helper_template/src/前端占位符检查脚本/加载和卸载时执行函数.ts","src://tavern_helper_template/webpack/bootstrap","src://tavern_helper_template/src/前端占位符检查脚本/监听AI生成完成.ts","src://tavern_helper_template/src/前端占位符检查脚本/添加按钮和注册按钮事件.ts"],"sourcesContent":["// 在加载脚本时执行某个函数\n$(() => {\n  toastr.success('前端占位符检查脚本已加载!', '脚本启动');\n});\n\n// 在卸载脚本时执行某个函数\n$(window).on('pagehide', () => {\n  toastr.info('前端占位符检查脚本已卸载!', '脚本关闭');\n});\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// 监听AI生成完成事件，自动检查并添加前端占位符\neventOn(tavern_events.GENERATION_ENDED, async (message_id: number) => {\n  // 延迟100ms确保消息已完全保存\n  setTimeout(async () => {\n    await checkAndAddPlaceholder(message_id);\n  }, 100);\n});\n\n/**\n * 检查指定楼层的消息是否包含前端占位符，如果没有则添加\n * @param message_id 消息楼层ID\n * @param mode 触发模式：'auto' 为自动添加，'manual' 为手动添加\n */\nasync function checkAndAddPlaceholder(message_id: number, mode: 'auto' | 'manual' = 'auto'): Promise<void> {\n  try {\n    const modeText = mode === 'auto' ? '自动' : '手动';\n    console.log(`[前端占位符] ${modeText}检查第 ${message_id} 楼消息`);\n\n    // 验证消息ID是否有效\n    if (typeof message_id !== 'number' || message_id < 0) {\n      console.log(`[前端占位符] 无效的消息ID: ${message_id}`);\n      return;\n    }\n\n    // 获取指定楼层的消息，使用字符串格式避免范围错误\n    let messages;\n    try {\n      messages = getChatMessages(message_id.toString());\n    } catch (rangeError) {\n      console.log(`[前端占位符] 消息ID ${message_id} 超出范围，尝试获取最新消息`);\n      // 如果指定的ID无效，则获取最新消息\n      messages = getChatMessages(-1);\n      if (messages && messages.length > 0) {\n        message_id = messages[0].message_id;\n        console.log(`[前端占位符] 改为${modeText}检查最新消息第 ${message_id} 楼`);\n      }\n    }\n\n    if (!messages || messages.length === 0) {\n      console.log(`[前端占位符] 无法获取消息内容`);\n      return;\n    }\n\n    const message = messages[0];\n    const placeholder = '【前端占位符】';\n\n    // 检查消息是否已包含占位符\n    if (!message.message.includes(placeholder)) {\n      // 在消息末尾添加占位符（另起一行）\n      const newMessage = message.message + '\\n' + placeholder;\n\n      // 修改消息内容\n      await setChatMessages([\n        {\n          message_id: message_id,\n          message: newMessage,\n        },\n      ]);\n\n      // 根据模式显示不同的成功提示\n      if (mode === 'auto') {\n        toastr.success(`自动添加界面成功！`, '自动检测完成');\n      } else {\n        toastr.success(`手动添加界面成功！`, '手动操作完成');\n      }\n\n      console.log(`[前端占位符] ${modeText}已在第 ${message_id} 楼添加占位符`);\n    } else {\n      console.log(`[前端占位符] 第 ${message_id} 楼已包含占位符，跳过${modeText}添加`);\n    }\n  } catch (error) {\n    // 根据模式显示不同的错误提示\n    const modeText = mode === 'auto' ? '自动' : '手动';\n    toastr.error(`${modeText}处理第 ${message_id} 楼消息时出错: ${error}`, `${modeText}操作失败`);\n    console.error(`[前端占位符] ${modeText}处理第 ${message_id} 楼消息时出错:`, error);\n  }\n}\n\n/**\n * 检查当前最新楼层是否包含前端占位符，如果没有则添加（手动模式）\n */\nexport async function checkLatestMessage(): Promise<void> {\n  try {\n    console.log(`[前端占位符] 手动检查最新消息`);\n    const message_id = getLastMessageId();\n    console.log(`[前端占位符] 获取到最新消息ID: ${message_id}`);\n\n    if (message_id === 0) {\n      toastr.warning('当前聊天没有消息', '提示');\n      return;\n    }\n\n    await checkAndAddPlaceholder(message_id, 'manual');\n  } catch (error) {\n    toastr.error(`获取最新消息时出错: ${error}`, '手动操作失败');\n    console.error(`[前端占位符] 获取最新消息时出错:`, error);\n  }\n}\n","import { checkLatestMessage } from './监听AI生成完成';\n\n// 添加手动检查按钮\n$(() => {\n  // 注册脚本按钮\n  replaceScriptButtons([{ name: '检查占位符', visible: true }]);\n\n  // 注册按钮点击事件\n  eventOn(getButtonEvent('检查占位符'), async () => {\n    toastr.info('正在检查最新消息的占位符...', '检查中');\n    await checkLatestMessage();\n  });\n});\n"],"names":["$","toastr","success","window","on","info","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","undefined","exports","module","__webpack_modules__","async","checkAndAddPlaceholder","message_id","mode","modeText","console","log","messages","getChatMessages","toString","rangeError","length","message","placeholder","includes","newMessage","setChatMessages","error","eventOn","tavern_events","GENERATION_ENDED","setTimeout","replaceScriptButtons","name","visible","getButtonEvent","getLastMessageId","warning","checkLatestMessage"],"sourceRoot":""}