# @types 文件夹使用说明

根据 `F:\ST\meituan-tavern-xjia\@types` 文件夹中的类型定义，以下是正确使用酒馆助手 API 的指南：

## 1. 获取用户名、角色名和用户信息

### 方法一：直接使用 SillyTavern API（推荐）
```typescript
// 获取用户名
const username = SillyTavern?.name1 || '玩家';

// 获取角色名
const characterName = SillyTavern?.name2 || '未知';

// 在模板中使用
// <h2>{{ SillyTavern?.name1 || '玩家' }}</h2>
```

### 方法二：通过变量获取
```typescript
// 通过酒馆变量获取
const userData = getVariables({ type: 'global' });
const username = userData?.user_name || '玩家';
```

## 2. 获取用户头像

### 使用 SillyTavern API 获取头像

```typescript
// 响应式变量
const userAvatar = ref<string>('');

// 获取用户头像函数
function getUserAvatar(): string {
  try {
    // 尝试从 accountStorage 获取头像
    if (SillyTavern?.accountStorage) {
      const avatarFile = SillyTavern.accountStorage.avatar || SillyTavern.accountStorage.user_avatar;
      if (avatarFile) {
        return SillyTavern.getThumbnailUrl('user', avatarFile);
      }
    }

    // 尝试从全局变量获取头像
    const globalVars = getVariables({ type: 'global' });
    if (globalVars?.avatar) {
      return SillyTavern.getThumbnailUrl('user', globalVars.avatar);
    }

    // 如果没有头像，返回空字符串使用默认图标
    return '';
  } catch (error) {
    console.error('获取头像失败:', error);
    return '';
  }
}

// 在组件初始化时获取头像
onMounted(() => {
  userAvatar.value = getUserAvatar();
});

// 在模板中使用
// <img v-if="userAvatar" :src="userAvatar" alt="用户头像" @error="userAvatar = ''" />
// <i v-else class="fas fa-user"></i>
```

## 3. MVU 变量框架使用

在使用 MVU 变量之前，必须先等待初始化：

```typescript
// 等待 MVU 初始化
await waitGlobalInitialized('Mvu');

// 获取最新消息楼层的 MVU 数据
const messageData = Mvu.getMvuData({ type: 'message', message_id: 'latest' });

// 获取聊天变量的 MVU 数据
const chatData = Mvu.getMvuData({ type: 'chat' });

// 获取角色卡变量的 MVU 数据
const characterData = Mvu.getMvuData({ type: 'character' });

// 获取全局变量的 MVU 数据
const globalData = Mvu.getMvuData({ type: 'global' });

// 从 MVU 数据中获取统计信息
const statData = messageData?.stat_data || {};

// 计算累计消费（从服务中的订单）
const totalSpending = computed(() => {
  const orders = statData['服务中的订单'] || statData.服务中的订单 || [];
  if (Array.isArray(orders)) {
    const total = orders.reduce((sum: number, order: any) => {
      const price = order.套餐?.套餐价格 || order.套餐价格 || 0;
      return sum + (typeof price === 'number' ? price : 0);
    }, 0);
    return total || 0;
  }
  return 0;
});

// 获取账户余额
const accountBalance = computed(() => {
  if (statData?.经济?.账户余额 !== undefined) {
    return statData.经济.账户余额;
  }
  return '--';
});
```

## 4. 最近服务逻辑

从历史订单中筛选出被下单次数最多的前3个订单：

```typescript
const recentServices = computed(() => {
  if (!historyItems.value || historyItems.value.length === 0) {
    return [];
  }

  // 筛选出有被下单次数的订单，并按次数降序排序
  const filteredItems = historyItems.value
    .filter((item: any) => {
      const orderCount = item.originalData?.性经验?.下单次数 || 0;
      return typeof orderCount === 'number' && orderCount > 0;
    });

  if (filteredItems.length === 0) {
    // 如果没有历史订单数据，使用前3个订单作为最近服务
    return historyItems.value.slice(0, 3).map((item: any, index: number) => ({
      id: index,
      name: item.girl_name || '未知',
      package: item.package_name || '未知套餐',
      count: item.originalData?.性经验?.下单次数 || 0,
      icon: 'fas fa-heart',
      time: item.order_time || '历史订单',
      status: getStatusClass(item.order_status || '已完成'),
      price: `¥${item.price || 0}`
    }));
  }

  const sortedServices = filteredItems
    .sort((a: any, b: any) => {
      const countA = a.originalData?.性经验?.下单次数 || 0;
      const countB = b.originalData?.性经验?.下单次数 || 0;
      return countB - countA; // 降序排列
    })
    .slice(0, 3); // 取前3个

  return sortedServices.map((item: any, index: number) => {
    const orderCount = item.originalData?.性经验?.下单次数 || 0;
    return {
      id: index,
      name: item.girl_name || '未知',
      package: item.package_name || '未知套餐',
      count: orderCount,
      icon: 'fas fa-heart',
      time: item.order_time || '历史订单',
      status: getStatusClass(item.order_status || '已完成'),
      price: `¥${item.price || 0}`
    };
  });
});
```

## 5. 数据初始化

### 在组件中正确初始化数据：

```typescript
// 初始化数据
async function initDisplay() {
  try {
    // 等待 MVU 初始化
    await waitGlobalInitialized('Mvu');

    const messages = await getChatMessages('latest');
    if (!messages || messages.length === 0 || !messages[0].data) {
      const loaded = await loadFullExampleData();
      if (loaded) return true;
      return false;
    }

    const statData = messages[0].data.stat_data;
    if (!statData) {
      const loaded = await loadFullExampleData();
      if (loaded) return true;
      return false;
    }

    fullStatData.value = statData;

    // 处理历史订单数据
    if (statData['历史订单'] && Array.isArray(statData['历史订单'])) {
      historyItems.value = statData['历史订单'].map((item: any) => {
        const order = Array.isArray(item) ? item[0] : item;
        return {
          girl_name: order.基础信息?.姓名?.[0] || order.姓名 || '未知',
          identity: order.基础信息?.身份?.[0] || order.身份 || '未知',
          package_name: order.套餐?.套餐名称?.[0] || order.套餐名称 || '未知套餐',
          order_time: '历史订单',
          order_status: order.订单状态 || '已完成',
          service_location: '未知',
          price: order.套餐?.套餐价格?.[0] || order.套餐价格 || 0,
          originalData: order  // 重要：添加原始数据，用于recentServices计算
        };
      });
    } else {
      historyItems.value = [];
    }

    return true;
  } catch (error) {
    console.error('加载失败:', error);
    return false;
  }
}

// 获取聊天消息
async function getChatMessages(messageId: string) {
  try {
    if (typeof window.Mvu === 'undefined' || !window.Mvu.getMvuData) return [];
    const response = window.Mvu.getMvuData({ type: 'message', message_id: messageId || 'latest' });
    return response && response.stat_data ? [{ data: response }] : [];
  } catch (error) {
    console.error('获取消息失败:', error);
    return [];
  }
}

// 加载本地示例数据
async function loadFullExampleData() {
  try {
    const res = await fetch('./变量示例.json');
    if (!res.ok) return false;
    const data = await res.json();
    const statData = data?.stat_data;
    if (!statData) return false;

    fullStatData.value = statData;

    if (statData['历史订单'] && Array.isArray(statData['历史订单'])) {
      historyItems.value = statData['历史订单'].map((item: any) => {
        const order = Array.isArray(item) ? item[0] : item;
        return {
          girl_name: order.基础信息?.姓名?.[0] || order.姓名 || '未知',
          identity: order.基础信息?.身份?.[0] || order.身份 || '未知',
          package_name: order.套餐?.套餐名称?.[0] || order.套餐名称 || '未知套餐',
          order_time: '历史订单',
          order_status: order.订单状态 || '已完成',
          service_location: '未知',
          price: order.套餐?.套餐价格?.[0] || order.套餐价格 || 0,
          originalData: order  // 重要：添加原始数据
        };
      });
    } else {
      historyItems.value = [];
    }

    return true;
  } catch (error) {
    console.error('加载本地数据失败:', error);
    return false;
  }
}
```

## 6. 设置按钮功能

实现重新生成首页店铺的功能：

```typescript
// 发送 AI 指令
function sendToAI(message: string) {
  console.log(`[发送至AI]: ${message}`);
  const fullCommand = `${message} | /trigger await=true`;
  if (typeof window.triggerSlash !== 'undefined') {
    try {
      window.triggerSlash(fullCommand);
      return true;
    } catch (e) {
      console.error('执行triggerSlash时出错:', e);
      return false;
    }
  } else {
    console.log(`[模拟发送至AI - 完整指令]: ${fullCommand}`);
    return false;
  }
}

// 重新生成首页店铺
function regenerateShops() {
  sendToAI('/send 生成-首页-熟人店铺2个-路人店铺2个');
}
```

## 7. 宏替换函数

如果需要手动处理宏替换，使用 `replaceMacros`：

```typescript
// 正确用法：使用模板字符串
const macroResult = await window.replaceMacros(`{{user}}`);

// 错误用法：使用字符串字面量（不会替换）
// const macroResult = await window.replaceMacros('{{user}}');
```

## 8. 核心 API 总结

根据 @types 文件夹中的定义，主要 API 包括：

### 变量操作
- `getVariables()` - 获取变量
- `replaceVariables()` - 替换变量
- `klona()` - 深度克隆对象

### 消息处理
- `getChatMessages()` - 获取聊天消息
- `sendMessage()` - 发送消息
- `getCurrentMessageId()` - 获取当前消息 ID

### STScript 命令
- `triggerSlash()` - 触发 STScript 命令
- `waitGlobalInitialized()` - 等待全局初始化

### MVU 变量框架
- `Mvu.getMvuData()` - 获取 MVU 数据
- `Mvu.replaceMvuData()` - 替换 MVU 数据
- `Mvu.parseMessage()` - 解析消息

### 角色卡相关
- `getCurrentCharacterId()` - 获取当前角色 ID
- `getCharacterCard()` - 获取角色卡

### 工具函数
- `toastr` - 消息提示
- `$`, `jQuery` - DOM 操作

### SillyTavern API
- `SillyTavern.name1` - 获取用户名
- `SillyTavern.name2` - 获取角色名
- `SillyTavern.accountStorage` - 获取用户账户存储
- `SillyTavern.getThumbnailUrl()` - 获取缩略图 URL

## 9. 注意事项

1. **等待初始化**：在使用 MVU 等功能前，必须先调用 `waitGlobalInitialized()`
2. **错误处理**：所有异步操作都应该有 try-catch 错误处理
3. **类型安全**：始终使用 TypeScript 类型检查
4. **数据验证**：使用 `zod` 进行数据校验和纠错
5. **响应式更新**：使用 Vue 的响应式系统管理状态
